# ç”¨æˆ·æ³¨å†Œ

è¿™ä¸ªå¤§å®¶éƒ½å†™äº†ä¸çŸ¥é“å¤šå°‘éäº†ï¼Œæ¢ä¸ªè¯­è¨€æ˜¯ä¸€æ ·çš„ï¼Œç®€å•è®¾è®¡ä¸‹è¡¨

## æ•°æ®åº“è®¾è®¡

- æ ¹æ®æ¡†æ¶è§„åˆ™ æ–°å¢demoåº“ï¼Œæ–°å¢userè¡¨

```sql
CREATE TABLE `user`
(
    `id`         bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'ç”¨æˆ·å…¨å±€å”¯ä¸€ä¸»é”®',
    `name`       varchar(50) COLLATE utf8mb4_unicode_ci                        NOT NULL DEFAULT '' COMMENT 'ç”¨æˆ·åç§°',
    `email`      varchar(191) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT '' COMMENT 'ç”¨æˆ·é‚®ç®±',
    `password`   varchar(255) COLLATE utf8mb4_unicode_ci                       NOT NULL DEFAULT '' COMMENT 'ç”¨æˆ·å¯†ç ',
    `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

## åŸºç¡€é…ç½®è°ƒæ•´

### æ–°å¢ MySQL & redis cache é…ç½®

åœ¨ `service/demo/etc/demo-api.yaml` ä¸­åŠ å…¥

```txt
Mysql:
  DataSource: demo:123456@tcp(192.168.56.101:53307)/demo?charset=utf8mb4&parseTime=true&loc=Asia%2FShanghai
RedisCache:
  - Host: 192.168.56.101:56379
    Pass: "123456"
```
åœ¨ `service/demo/api/internal/config/config.go` ä¸­åŠ å…¥

```txt
	Mysql struct {
		DataSource string
	}
    RedisCache cache.CacheConf
```
## ç”Ÿæˆ é€šè¿‡ goland æ’ä»¶ ç”Ÿæˆ doc/user.api

åªä¿ç•™ æ–‡ä»¶å†…çš„è¯·æ±‚å“åº”å‚æ•°ï¼Œå…¶ä»–å»é™¤,æˆ‘ä»¬å®šä¹‰è¯·æ±‚/ å“åº”ä¿¡æ¯
```json
{
    "email": "xx@163.com",
    "name": "xx",
    "password": "xx"
}
```
å“åº”ä¿¡æ¯
```json
{
  "code": 200,
  "msg": "xx",
  "data": {}
}
```
æˆ‘ä»¬åŠ å…¥ å¦‚ä¸‹ç»“æ„ä½œä¸ºæœ¬æ¬¡è¯·æ±‚ä¸å“åº”çš„å‡ºå…¥å‚
```api
type (
    UserRegisterReq {
        Email string `json:"email"`
        Name string `json:"name"`
        Password string `json:"password"`
    }

    UserRegisterReply {
        Code int `json:"code"`
        Msg string `json:"msg"`
        Data interface{} `json:"data"`
    }
)
```
å†åœ¨ demo.api ä¸­å¼•å…¥ user.api ,å¹¶å°†æœåŠ¡å®šä¹‰å¥½
```api
import (
	"doc/user.api"
)

service demo-api {
    @handler userregisterhandler
    post /api/user/register (UserRegisterReq) returns (UserRegisterReply)
}
```
[codeç”Ÿæˆ](./image/Snipaste_2023-02-18_11-26-57.png)

- ğŸ˜± æ³¨æ„çš„ç‚¹ï¼Œide å¯èƒ½ä¸ä¼šä¸»åŠ¨å»æŠŠç”Ÿæˆçš„æ–‡ä»¶çº³å…¥è¿›è¡Œï¼Œéœ€è¦æ‰‹åŠ¨å» reload from dick
- å› ä¸ºåŠ å…¥äº† redis æ‰€ä»¥éœ€è¦ï¼Œé‡æ–° `go mod tidy` æ‹‰å–æ–°çš„ åŒ…

## éªŒè¯å™¨
æ ¹æ®ä½†æœ‰ä¸€è¯´ä¸€ go-zero å¯¹è¿™å—å¤„ç†ä¸Šéƒ½å¾ˆç®€é™‹ï¼Œ[æ–‡æ¡£](https://go-zero.dev/cn/docs/design/grammar#type%E8%AF%AD%E6%B3%95%E5%9D%97)ä¹Ÿä¸å¤ªå¥½æ‰¾

æˆ‘ä»¬è¦å®ç°ï¼Œå¯¹ç”¨æˆ·ä¼ å…¥çš„å‚æ•°åšéªŒè¯ï¼Œæ¯”å¦‚é‚®ç®±ï¼Œå¯†ç ï¼Œç”¨æˆ·åï¼Œå¹¶è¿›è¡Œå‹å¥½æç¤ºï¼Œæ‰€ä»¥éœ€è¦å¼•å…¥æ–°çš„åŒ…ï¼Œå¹¶å¯¹è¿™ä¸ªåŠŸèƒ½è¿›è¡Œæ”¹é€ 

### validate

- å¼•å…¥ "github.com/go-playground/validator/v10" å¹¶å¯¹ `service/demo/api/internal/handler/userregisterhandler.go` è¿›è¡Œæ”¹é€ 

åœ¨ `userregisterhandler func` ä¸­å¼•å…¥äºŒæ¬¡çš„è§„åˆ™éªŒè¯

```text
// validate check
if err := validator.New().StructCtx(r.Context(), req); err != nil {
    httpx.ErrorCtx(r.Context(), w, err)
    return
}
```

- ä¿®æ”¹`service/demo/api/doc/user.api`å¢åŠ éªŒè¯

```api
type(
    UserRegisterReq {
        Email string `json:"email" validate:"required,email"`
        Name string `json:"name" validate:"required,max=50"`
        Password string `json:"password" validate:"required"`
    }
)
```

### validateçš„é”™è¯¯ä¿¡æ¯æœ¬åœ°åŒ–

ä½†æ­¤æ—¶ï¼Œé”™è¯¯å“åº”ä¸ºé»˜è®¤çš„è‹±æ–‡è¾“å‡ºï¼Œä¸ºäº†æ›´å‹å¥½çš„ç”¨æˆ·æç¤ºï¼Œæˆ‘ä»¬å¼•å…¥ ç¿»è¯‘å™¨æ¥å®ç°æœ¬åœ°åŒ– ï¼Œå…·ä½“å®ç°åœ¨ `common/validator/validator.go` ä¸­

- ä¿®æ”¹`service/demo/api/doc/user.api`å¢åŠ æœ¬åœ°åŒ–éªŒè¯

```api
type(
    UserRegisterReq {
        Email string `json:"email,optional" validate:"required,email" label:"é‚®ç®±"`
        Name string `json:"name,optional" validate:"required,max=50" label:"ç”¨æˆ·å"`
        Password string `json:"password,optional" validate:"required" label:"å¯†ç "`
    }
)
```
å› ä¸ºæˆ‘ä»¬ä½¿ç”¨äº† æ¡†æ¶ `httpx` å»åš json åˆ° struct çš„è½¬åŒ–ï¼Œè€Œæ¡†æ¶æœ¬èº«å¯¹äºå­—æ®µé»˜è®¤ä¸ºå¼ºåˆ¶æ ¡éªŒï¼Œæ‰€ä»¥éœ€è¦ç»Ÿä¸€ç”Ÿæˆä¸º optional

åœ¨ `userregisterhandler func` ä¸­å¼•å…¥`"go-zero-demo/common/validator"` ä¸ç¿»è¯‘å™¨

```text
// validate check
if err := validator.Validate.StructCtx(r.Context(), req); err != nil {
    errMap := validator.Translate(err, &req)
    for _, errFormat := range errMap {
    httpx.ErrorCtx(r.Context(), w, fmt.Errorf(errFormat))
    return
    }
    httpx.ErrorCtx(r.Context(), w, err)
    return
}
```

### éªŒè¯å™¨ä¸æ¨¡æ¿ç”Ÿæˆ
- `goctl template init` å»æŠŠæ¨¡æ¿ç”Ÿæˆåœ¨ `~/.goctl/v1.4.4/` ä¸‹
å¦‚æœæ¯æ¬¡éƒ½éœ€è¦ è¿›è¡Œæ‰‹åŠ¨çš„éªŒè¯ï¼Œé‚£ä¹ˆå°±ä¼šå¾ˆéº»çƒ¦ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†è¿™ä¸ªè¿‡ç¨‹è‡ªåŠ¨åŒ–ï¼Œä¿®æ”¹ä»£ç æ¨¡æ¿ `template/api/hander.tpl`,è®°å¾—å¤‡ä»½å‘€

å†æ¬¡ç”Ÿæˆå°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„äº†

## ç»Ÿä¸€å…¨å±€å“åº”ä¸æ¨¡æ¿æ”¹é€ 

åˆšåˆšæˆ‘ä»¬å·²ç»å®ç°äº†å¯¹ç”¨æˆ·è¾“å…¥çš„å‚æ•°è¿›è¡Œäº†éªŒè¯ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜éœ€è¦å¯¹å„ç±»å“åº”çš„æ•°æ®è¿›è¡Œç»Ÿä¸€çš„å¤„ç†

å…·ä½“å®ç°åœ¨ `"go-zero-demo/common/response"` ä¸­

ç”±æ­¤å¯¹ `service/demo/api/internal/handler/userregisterhandler.go` çš„å“åº”è¿›è¡Œæ”¹é€ ï¼Œå¹¶é€šè¿‡æ¨¡æ¿å›ºå®šä¸‹æ¥

## modelå±‚

åœ¨è¿›å…¥ logic åå¾ˆæ˜¾ç„¶è¦å»ç¡®è®¤ ç”¨æˆ·é‚®ç®±æ˜¯å¦å­˜åœ¨ï¼Œæ¥è¿›è¡Œæ³¨å†Œæ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å»å®ç° model å±‚

æ–°å¢ `service/demo/model/user.sql` æŠŠä¸Šè¿°çš„sql è¯­å¥æ”¾å…¥ï¼Œç„¶åå³é”® ç”Ÿæˆ model ç›¸å…³ä»£ç 

åœ¨ `service/demo/api/internal/svc/servicecontext` ä¸­, æŠŠ model å®ä¾‹åŒ–åæ”¾å…¥

```text
type ServiceContext struct {
	Config    config.Config
	UserModel model.UserModel
}

func NewServiceContext(c config.Config) *ServiceContext {
	conn := sqlx.NewMysql(c.Mysql.DataSource)

	return &ServiceContext{
		Config:    c,
		UserModel: model.NewUserModel(conn, c.RedisCache),
	}
}
```

è¿™ä¸ªæ—¶å€™å°±å¯ä»¥å¼€å§‹å†™ä¸šåŠ¡ä»£ç äº†ï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°ï¼Œç”Ÿæˆçš„ä»£ç æä¾›çš„db æ–¹æ³•å®åœ¨æ˜¯å°‘çš„å¯æ€œï¼Œæ‰€ä»¥éœ€è¦è‡ªå·±å»å†™ï¼Œä¿®æ”¹æ¨¡æ¿

### model ä¸æ¨¡æ¿

æ ¹æ® `template/model/model.tpl` è¿›è¡Œä¿®æ”¹ï¼Œè®°å¾—å¤‡ä»½

## æ³¨å†Œé€»è¾‘å®Œå–„

åœ¨ `service/demo/api/internal/logic/userregisterlogic.go` ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ç”¨æˆ·çš„æ³¨å†Œé€»è¾‘è¿›è¡Œå®Œå–„,
æ³¨æ„æŸ¥è¯¢å­˜åœ¨ï¼Œsql rowä¸º null çš„error ï¼Œå…¶ä»–åœ°æ–¹ä»£ç è¿˜æ˜¯å¾ˆç®€æ´çš„
