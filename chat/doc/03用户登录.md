# ç”¨æˆ·ç™»å½•

## è®¤è¯é»˜è®¤å…ˆä½¿ç”¨ jwt
åœ¨ `service/demo/etc/demo-api.yaml` ä¸­åŠ å…¥

```txt
Auth:
  AccessSecret: "13450cd8841c0f0"
  AccessExpire: 2592000
```
åœ¨ `service/demo/api/internal/config/config.go` ä¸­åŠ å…¥

```txt
	Auth       struct {
		AccessSecret string
		AccessExpire int64
	}
```

## é…ç½®ä¿®æ”¹ï¼Œä»£ç ç”Ÿæˆ

- åœ¨ `doc/user.api` ä¸­åŠ å…¥ ç™»å½•ç›¸å…³å‚æ•°

```api
type (
    UserLoginReq {
        Name string `json:"name,optional" validate:"required,max=50" label:"ç”¨æˆ·å"`
        Password string `json:"password,optional" validate:"required" label:"å¯†ç "`
    }

    UserLoginReply {
        Token string `json:"token"`
    }
)
```

- åœ¨ `demo.api`  ä¸­åŠ å…¥ ç™»å½•ç›¸å…³å¤„ç†æ–¹æ³•

```txt
service demo-api {
    @handler UserLoginHandler
    post /api/user/login (UserLoginReq) returns (UserLoginReply)
} 
```

- ç„¶åå³é”® ide ä»£ç ç”Ÿæˆ

### ç™»å½•å¤„ç†

åŸºæœ¬é€»è¾‘å†™ä¸€å†™ï¼ŒğŸ†— ä¸€ä¸ªæœ€æœ€æœ€åŸºæœ¬çš„ç”¨æˆ·ç³»ç»Ÿå®Œæˆäº†

## è®°å½• è¯·æ±‚ä¸å“åº” log  

- å› ä¸º æˆ‘ä»¬å®ç° å…¨å±€ response å“åº”æ—¥å¿—å¥½è®°å½• åœ¨ `common/response/response.go` ä¸­åŠ å…¥ä¸€è¡Œå³å¯

### è¯·æ±‚æ—¥å¿—ï¼Œè¿™ç§ä¸œè¥¿å°±å¾ˆé€‚åˆæä¸€ä¸ª middleware å»å¤„ç†

- åœ¨ `demo.api`  ä¸­åŠ å…¥ è®°å½•ä¸­é—´ä»¶

```txt
@server(
	middleware: AccessLog // è·¯ç”±ä¸­é—´ä»¶å£°æ˜
)
```

å…·ä½“å®ç°çœ‹ `service/demo/api/internal/middleware/accesslogmiddleware.go`

ç„¶ååœ¨ `service/demo/api/internal/svc/servicecontext.go` ä¸­åŠ å…¥

```txt
type ServiceContext struct {
	Config    config.Config
	UserModel model.UserModel
	AccessLog rest.Middleware
}

func NewServiceContext(c config.Config) *ServiceContext {
	conn := sqlx.NewMysql(c.Mysql.DataSource)

	return &ServiceContext{
		Config:    c,
		UserModel: model.NewUserModel(conn, c.RedisCache),
		AccessLog: middleware.NewAccessLogMiddleware().Handle,
	}
}
```